image: node:20

stages:
  - build
  - scan
  - deploy

build:
  stage: build
  script:
    - npm ci || npm install
    - npm run build
  artifacts:
    paths:
      - node_modules/
      - dist/
    expire_in: 1 day

security_scan:
  stage: scan
  needs: ["build"]
  script:
    - echo "Running RepoGuardian security scan..."
    - node dist/cli.js --output repoguardian-report.json || true
    - echo "Scan completed successfully"
  artifacts:
    paths:
      - repoguardian-report.json
    when: always
    expire_in: 30 days
  allow_failure: true

pages:
  stage: deploy
  needs: ["security_scan"]
  script:
    - mkdir -p public
    - cp -r docs/* public/ 2>/dev/null || echo "[]" > public/index.html
    - mkdir -p public/data
    - cp repoguardian-report.json public/data/latest-report.json 2>/dev/null || echo '{"detectionsFound":0,"filesScanned":0,"timestamp":"N/A","detections":[]}' > public/data/latest-report.json
    - echo "GitLab Pages deployed successfully"
  artifacts:
    paths:
      - public
  only:
    - main

release_job:
  stage: release
  needs: ["package_extension"]
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Creating release for tag ${CI_COMMIT_TAG}"
  release:
    tag_name: '${CI_COMMIT_TAG}'
    description: |
      ## RepoGuardian X ${CI_COMMIT_TAG}
      
      **Local-first security scanning extension for VS Code**
      
      ### Installation
      1. Download the `.vsix` file from the assets below
      2. Open VS Code
      3. Run: `Extensions: Install from VSIX...`
      4. Select the downloaded file
      
      ### Features
      - ğŸ”’ 100% offline security scanning
      - ğŸ­ Automatic secret masking
      - ğŸš« Pre-push hook protection
      - ğŸ“Š GitLab CI integration
      - ğŸ” VS Code Problems panel integration
      
      See README.md for full documentation.
    assets:
      links:
        - name: 'RepoGuardian X Extension (.vsix)'
          url: '${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/repoguardian-x-${CI_COMMIT_TAG}.vsix'
          link_type: 'package'
  only:
    - tags

include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
